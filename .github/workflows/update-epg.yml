name: Refresh EPG Daily

on:
  schedule:
    - cron: '0 4 * * *'               # 4 AM UTC (~8 PM previous day Vancouver time)
  workflow_dispatch:                  # manual button in Actions tab

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python deps (if using merge script)
        run: pip install lxml requests

      - name: Clone iptv-org/epg
        run: git clone --depth 1 https://github.com/iptv-org/epg.git epg-grabber

      - name: Install grabber dependencies
        working-directory: epg-grabber
        run: npm ci

      - name: Generate & merge EPG (example for CA, US, GB – add more countries here)
        run: |
          cd epg-grabber
          # Example: run grabber for a few sites/countries → output guide.xml
          npm run grab -- --site=cbc.ca --site=ctv.ca --site=globaltv.com --days=7 --output=../data/CA/guide.xml --gzip=false

          # Repeat for other countries or use a loop with different --site lists
          # npm run grab -- --site=abc.go.com --site=nbc.com --days=7 --output=../data/US/guide.xml --gzip=false

      - name: Merge & compress (if multiple files produced)
        run: python scripts/merge-xmltv.py   # your merge script – see below

      - name: Generate index.json
        run: |
          python - <<EOF
          import json, os, datetime
          data = {}
          for country in os.listdir('data'):
              if os.path.isdir(f'data/{country}'):
                  files = [f for f in os.listdir(f'data/{country}') if f.endswith('.xml.gz')]
                  if files:
                      size = sum(os.path.getsize(f'data/{country}/{f}') for f in files) / (1024*1024)
                      data[country] = {
                          "files": files,
                          "size_mb": round(size, 1),
                          "updated": datetime.datetime.utcnow().isoformat() + "Z"
                      }
          with open('data/index.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Commit changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add data/
          git commit -m "Daily EPG refresh $(date +'%Y-%m-%d')" || echo "No changes"
          git push
